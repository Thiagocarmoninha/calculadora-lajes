<script>
  async function analisarComIA() {
    const pdfFile = document.getElementById('uploadPdf').files[0];
    const imgFile = document.getElementById('uploadImagem').files[0];

    if (!pdfFile && !imgFile) {
      alert('Faça upload de pelo menos um arquivo (PDF ou imagem) para análise.');
      return;
    }

    // Por enquanto, suporte apenas imagem (PDF pode ser adicionado com conversão no backend)
    let fileToSend = imgFile;
    if (pdfFile && !imgFile) {
      alert('PDF não suportado ainda. Use imagem (JPG/PNG).');
      return;
    }

    const formData = new FormData();
    formData.append('file', fileToSend);

    try {
      // Substitua pela URL real do seu backend no Cloudflare
      const response = await fetch('https://seu-backend-cloudflare.com/analisar', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erro na análise.');
      }

      const data = await response.json();
      console.log('Dados da IA:', data); // Debug

      // Preencher campos com dados da IA
      document.getElementById('largura').value = data.largura || 2.0;
      document.getElementById('comprimento').value = data.comprimento || 5.0;
      document.getElementById('alturaViga').value = data.alturaViga || 'H12';

      alert('Análise concluída! Campos preenchidos automaticamente.');
    } catch (error) {
      console.error('Erro:', error); // Debug
      alert('Erro: ' + error.message);
    }
  }

  function calcular() {
    const W = parseFloat(document.getElementById('largura').value); // Largura em metros
    let C = parseFloat(document.getElementById('comprimento').value); // Comprimento em metros
    const alturaViga = document.getElementById('alturaViga').value;
    const precoViga = parseFloat(document.getElementById('precoViga').value);
    const precoIsopor = parseFloat(document.getElementById('precoIsopor').value);

    if (!W || !C || !alturaViga || !precoViga || !precoIsopor) {
      alert('Preencha todos os campos!');
      return;
    }

    // Ajustar comprimento mínimo para 1m, incrementos de 0.10m
    if (C < 1) {
      alert('Comprimento mínimo é 1 metro. Ajustando para 1m.');
      C = 1;
    }
    C = Math.round(C / 0.1) * 0.1; // Arredondar para múltiplo de 0.10

    // Constantes em metros: viga = 0.13 m, isopor = 0.3 m
    const vigaLargura = 0.13;
    const isoporLargura = 0.3;

    // Cálculo: n = ceil((W + isoporLargura) / (vigaLargura + isoporLargura))
    const ciclo = vigaLargura + isoporLargura; // 0.43 m
    const n = Math.ceil((W + isoporLargura) / ciclo);
    const m = n - 1;
    const larguraCoberta = n * vigaLargura + m * isoporLargura;

    // Quantidades
    const qtdViga = n * C; // metros lineares de viga
    const qtdIsopor = qtdViga; // EPS = metros lineares de viga (1 EPS por metro linear)

    // Orçamento
    const custoViga = qtdViga * precoViga;
    const custoIsopor = qtdIsopor * precoIsopor;
    const total = custoViga + custoIsopor; // Total sem margem

    // Exibir resultado — **agora com backticks**
    document.getElementById('resultado').innerHTML = `
      <h3>Resultado do Cálculo:</h3>
      <p>Altura da Viga Selecionada: ${alturaViga}</p>
      <p>Número de Vigas: ${n}</p>
      <p>Número de EPS (Isopor): ${qtdIsopor.toFixed(2)}</p>
      <p>Largura Coberta: ${larguraCoberta.toFixed(2)} metros</p>
      <p>Comprimento Ajustado da Laje: ${C.toFixed(2)} metros</p>
      <p>Quantidade de Viga: ${qtdViga.toFixed(2)} metros lineares</p>
      <p>Quantidade de EPS: ${qtdIsopor.toFixed(2)} metros lineares</p>
      <h4>Orçamento:</h4>
      <p>Custo Vigas: ${formatBRL(custoViga)}</p>
      <p>Custo EPS: ${formatBRL(custoIsopor)}</p>
      <p><strong>Total: ${formatBRL(total)}</strong></p>
    `;

    document.getElementById('comprarBtn').style.display = 'block';
  }

  function adicionarCarrinho() {
    const resultado = document.getElementById('resultado').innerText;
    document.getElementById('carrinho').innerHTML = `
      <h3>Carrinho de Compras</h3>
      <p>Item adicionado:</p>
      <pre>${resultado}</pre>
      <p><em>Simulação: Em um site real, isso seria enviado para um sistema de pagamento.</em></p>
    `;
    document.getElementById('carrinho').style.display = 'block';
  }

  // helper para moeda BRL
  function formatBRL(v) {
    return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
</script>
