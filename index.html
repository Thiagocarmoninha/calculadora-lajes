<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento e Compra de Lajes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-top: 10px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            margin-top: 20px;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            display: none;
        }
        #aiResult {
            margin-top: 20px;
            padding: 10px;
            background-color: #d4edda;
            border-radius: 4px;
            display: none;
        }
        #buy {
            margin-top: 10px;
            background-color: #007bff;
        }
        #buy:hover {
            background-color: #0056b3;
        }
        #processFile {
            background-color: #ffc107;
            color: black;
        }
        #processFile:hover {
            background-color: #e0a800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Orçamento e Compra de Lajes</h1>
        <p>Insira as dimensões da laje (comprimento e largura em metros), selecione a altura da viga e os preços para calcular o orçamento. A laje é composta por vigas (13 cm de largura) e EPS (isopor, 30 cm x 100 cm), sempre terminando com uma viga para apoio. O comprimento mínimo da viga é 1 metro, com incrementos de 0,10 metros.</p>
        
        <!-- Seção para upload e processamento com IA -->
        <h2>Processar Arquivo com IA (OpenAI)</h2>
        <p>Faça upload de uma imagem (JPG/PNG) ou PDF para que a IA identifique as lajes em cada cômodo e extraia medidas.</p>
        <label for="apiKey">Chave da API OpenAI:</label>
        <input type="password" id="apiKey" placeholder="Insira sua chave API" required>
        
        <label for="fileUpload">Arquivo (Imagem ou PDF):</label>
        <input type="file" id="fileUpload" accept=".jpg,.jpeg,.png,.pdf" required>
        
        <button type="button" id="processFile" onclick="processFile()">Processar com IA</button>
        
        <div id="aiResult">
            <h3>Resultados da IA:</h3>
            <p id="aiOutput"></p>
        </div>
        
        <!-- Formulário de orçamento -->
        <h2>Calcular Orçamento</h2>
        <form id="calcForm">
            <label for="length">Comprimento da laje (m, mínimo 1, incrementos 0.10):</label>
            <input type="number" id="length" step="0.10" min="1" required>

            <label for="width">Largura da laje (m):</label>
            <input type="number" id="width" step="0.01" required>

            <label for="height">Altura da viga:</label>
            <select id="height" required>
                <option value="8">H8</option>
                <option value="12">H12</option>
                <option value="16">H16</option>
                <option value="20">H20</option>
                <option value="24">H24</option>
                <!-- Adicione mais opções se necessário -->
            </select>

            <label for="priceViga">Preço por metro de viga (R$):</label>
            <input type="number" id="priceViga" step="0.01" required>

            <label for="priceIsopor">Preço por m² de EPS (isopor) (R$):</label>
            <input type="number" id="priceIsopor" step="0.01" required>

            <button type="button" onclick="calculate()">Calcular Orçamento</button>
        </form>
        <div id="result">
            <h3>Resultado do Orçamento:</h3>
            <p id="vigas"></p>
            <p id="eps"></p>
            <p id="totalCost"></p>
            <button id="buy" onclick="buy()">Comprar</button>
        </div>
    </div>

    <script>
        async function processFile() {
            const apiKey = document.getElementById('apiKey').value;
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];

            if (!apiKey || !file) {
                alert('Por favor, insira a chave API e selecione um arquivo.');
                return;
            }

            const fileType = file.type;
            let content;

            if (fileType.startsWith('image/')) {
                // Para imagens, converter para base64
                content = await toBase64(file);
                // Usar GPT-4 Vision
                const response = await callOpenAI(apiKey, `Analise esta imagem de um projeto de construção. Identifique cada cômodo e extraia as medidas das lajes (comprimento e largura em metros). Retorne no formato: laje1: comprimento x largura, laje2: ..., etc.`, content, true);
                displayAIResult(response);
            } else if (fileType === 'application/pdf') {
                // Para PDFs, assumir que é texto extraído (em um site real, use uma biblioteca como pdf-parse)
                // Simulação: ler como texto se possível, ou alertar
                alert('Processamento de PDFs requer extração de texto. Em um site real, integre uma biblioteca como pdf-parse. Por enquanto, converta o PDF para imagem.');
                return;
            } else {
                alert('Tipo de arquivo não suportado.');
                return;
            }
        }

        async function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Remover prefixo data:...
                reader.onerror = error => reject(error);
            });
        }

        async function callOpenAI(apiKey, prompt, imageBase64, isImage = false) {
            const url = 'https://api.openai.com/v1/chat/completions';
            const headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            };

            const messages = [{ role: 'user', content: prompt }];
            if (isImage) {
                messages[0].content = [
                    { type: 'text', text: prompt },
                    { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } }
                ];
            }

            const body = {
                model: isImage ? 'gpt-4-vision-preview' : 'gpt-4',
                messages: messages,
                max_tokens: 500
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (response.ok) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                alert('Erro ao chamar OpenAI: ' + error.message);
                return null;
            }
        }

        function displayAIResult(result) {
            if (result) {
                document.getElementById('aiOutput').textContent = result;
                document.getElementById('aiResult').style.display = 'block';
            }
        }

        function calculate() {
            const L = parseFloat(document.getElementById('length').value);
            const W = parseFloat(document.getElementById('width').value) * 100; // converter para cm
            const height = document.getElementById('height').value;
            const priceViga = parseFloat(document.getElementById('priceViga').value);
            const priceIsopor = parseFloat(document.getElementById('priceIsopor').value);

            if (isNaN(L) || isNaN(W) || isNaN(priceViga) || isNaN(priceIsopor) || L < 1 || W <= 0 || priceViga < 0 || priceIsopor < 0) {
                alert('Por favor, insira valores válidos. Comprimento mínimo 1m.');
                return;
            }

            // Verificar se L é múltiplo de 0.10 (aproximadamente)
            if ((L * 10) % 1 !== 0) {
                alert('O comprimento deve ser em incrementos de 0,10 metros.');
                return;
            }

            // Largura da viga: 13 cm, EPS: 30 cm
            // Sequência: viga, EPS, viga, EPS, ..., viga (termina com viga)
            let numVigas = Math.ceil((W + 30) / 43);
            let numIsoporSections = numVigas - 1;

            // Ajustar se necessário
            let coveredWidth = numVigas * 13 + numIsoporSections * 30;
            if (coveredWidth < W) {
                numVigas++;
                numIsoporSections++;
            }

            // Total metros lineares de viga: numVigas * L
            const totalVigaMeters = numVigas * L;

            // Quantidade de EPS: total metros lineares de viga (cada EPS cobre 1m linear)
            const numEPS = totalVigaMeters;

            // Área total de EPS: numEPS * 0.30 m²
            const totalEPSArea = numEPS * 0.30;

            // Custos
            const costVigas = totalVigaMeters * priceViga;
            const costEPS = totalEPSArea * priceIsopor;
            const totalCost = costVigas + costEPS;

            // Exibir resultados
            document.getElementById('vigas').textContent = `Quantidade de vigas: ${totalVigaMeters.toFixed(2)} metros (altura ${height} cm)`;
            document.getElementById('eps').textContent = `Quantidade de EPS: ${numEPS.toFixed(2)} unidades (área total: ${totalEPSArea.toFixed(2)} m²)`;
            document.getElementById('totalCost').textContent = `Custo total: R$ ${totalCost.toFixed(2)}`;
            document.getElementById('result').style.display = 'block';
        }

        function buy() {
            alert('Compra realizada! (Simulação - em um site real, isso redirecionaria para um sistema de pagamento.)');
            // Aqui você pode integrar com um sistema de e-commerce real, como Stripe ou PayPal.
        }
    </script>
</body>
</html>
