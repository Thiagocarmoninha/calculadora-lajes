<script>
const $ = (id) => document.getElementById(id);

function setLoading(isLoading) {
  const btn = $("analisarBtn");
  if (!btn) return;
  btn.disabled = isLoading;
  btn.innerText = isLoading ? "Analisando..." : "Analisar com IA";
}

async function analisarComIA() {
  const pdfFile = $("uploadPdf").files[0];
  const imgFile = $("uploadImagem").files[0];

  if (!pdfFile && !imgFile) {
    alert("Faça upload de pelo menos um arquivo (PDF ou imagem).");
    return;
  }

  const formData = new FormData();
  if (imgFile) formData.append("file", imgFile, imgFile.name);
  if (pdfFile) formData.append("file", pdfFile, pdfFile.name);

  setLoading(true);
  try {
    const resp = await fetch("/api/analisar", {
      method: "POST",
      body: formData,
    });

    if (!resp.ok) {
      const text = await resp.text().catch(() => "");
      throw new Error(text || `Falha (${resp.status})`);
    }

    const data = await resp.json();

    // Normaliza e preenche campos
    $("largura").value = Number(data.largura ?? 2.0);
    $("comprimento").value = Number(data.comprimento ?? 5.0);
    $("alturaViga").value = String(data.alturaViga ?? "H12");

    alert("Análise concluída! Campos preenchidos automaticamente.");
  } catch (err) {
    console.error(err);
    alert("Erro na análise: " + (err?.message || "desconhecido"));
  } finally {
    setLoading(false);
  }
}

// adiciona o id ao botão existente
(function ensureAnalyzeBtn() {
  const btns = document.getElementsByTagName("button");
  for (const b of btns) {
    if (b.textContent?.includes("Analisar com IA")) {
      b.id = "analisarBtn";
      b.onclick = analisarComIA;
      break;
    }
  }
})();

// teu calcular() e adicionarCarrinho() permanecem como estão
</script>
